# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤構築
- [x] 1.1 バックエンドプロジェクトの初期化
  - Node.js + TypeScriptプロジェクトを作成し、Fastify、Prisma、Zodをセットアップする
  - SQLiteデータベースファイルの作成とPrisma接続設定を行う
  - 環境変数管理（dotenv）とマスターキー設定を構成する
  - 開発用スクリプト（dev、build、start）を設定する
  - _Requirements: 10.1_

- [x] 1.2 (P) フロントエンドプロジェクトの初期化
  - React + Vite + TypeScriptプロジェクトを作成する
  - Tailwind CSS、TanStack Query、Rechartsをセットアップする
  - vite-plugin-pwaを導入しPWA基本設定を行う
  - APIクライアント用のfetch設定とエラーハンドリングを構成する
  - _Requirements: 11.1, 11.2_

- [x] 1.3 データベーススキーマの定義
  - Prismaスキーマで5つのモデル（Account、Transaction、Category、AutoRule、Job）を定義する
  - リレーションシップ、インデックス、ユニーク制約を設定する
  - 初回マイグレーションを実行してDBを初期化する
  - _Requirements: 3.3, 5.1_

- [x] 2. セキュリティモジュール実装
- [x] 2.1 暗号化サービスの実装
  - AES-256-GCMによる暗号化・復号機能を実装する
  - 各暗号化でユニークなIVを生成し、認証タグを付与する
  - マスターキーの環境変数からの読み込みとバリデーションを行う
  - 復号操作時のアクセスログ記録機能を実装する
  - _Requirements: 9.4, 10.1, 10.2, 10.3_

- [ ] 3. 費目（カテゴリ）管理機能
- [ ] 3.1 費目サービスの実装
  - 費目のCRUD操作（作成、読取、更新、削除）を実装する
  - デフォルト費目リスト（15項目）のシード処理を実装する
  - 費目名の重複チェックとユニーク制約を適用する
  - 使用中の費目削除時に取引件数を返却し、削除を防止する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 3.2 費目APIエンドポイントの実装
  - GET /api/categories で全費目一覧を取得する
  - POST /api/categories で新規費目を作成する
  - PATCH /api/categories/:id で費目名を更新する
  - DELETE /api/categories/:id で費目を削除する（使用中は409エラー）
  - Zodスキーマによるリクエストバリデーションを適用する
  - _Requirements: 5.2, 5.3, 5.4, 5.5_

- [ ] 4. 口座管理機能
- [ ] 4.1 口座サービスの実装
  - 口座のCRUD操作を実装する
  - 口座種別（BANK、CARD、SECURITIES、CASH）の管理を行う
  - 認証情報をSecurityModuleで暗号化して保存する
  - 残高更新機能を実装する
  - _Requirements: 8.1, 8.2, 9.1, 9.2, 9.3, 9.4_

- [ ] 4.2 口座APIエンドポイントの実装
  - GET /api/accounts で全口座と残高一覧を取得する
  - POST /api/accounts で新規口座を登録する
  - PATCH /api/accounts/:id で口座情報・認証情報を更新する
  - DELETE /api/accounts/:id で口座を削除する
  - 口座種別ごとのグループ化をレスポンスに含める
  - _Requirements: 8.1, 8.3, 9.1, 9.2, 9.3_

- [ ] 5. 取引管理機能
- [ ] 5.1 取引サービスの実装
  - 取引のCRUD操作を実装する
  - 手動入力フラグ（isManual）の管理を行う
  - externalIdによる重複チェック機能を実装する
  - 月別・口座別の取引取得クエリを実装する
  - _Requirements: 1.2, 1.3, 3.1, 3.2, 3.3, 4.1, 4.2_

- [ ] 5.2 取引APIエンドポイントの実装
  - GET /api/transactions で月別・口座別の取引一覧を取得する
  - POST /api/transactions で手動取引を登録する
  - PATCH /api/transactions/:id で取引を更新する
  - DELETE /api/transactions/:id で取引を削除する
  - _Requirements: 3.1, 3.2, 3.3, 4.1, 4.2_

- [ ] 6. 分類ルール管理機能
- [ ] 6.1 分類ルールサービスの実装
  - 摘要キーワードと費目の紐付けを管理する
  - キーワード検索によるルール取得機能を実装する
  - ルールの作成・更新（UPSERT）を実装する
  - _Requirements: 4.3, 6.1, 6.5_

- [ ] 6.2 費目修正時の学習ルール自動登録
  - 取引の費目が手動修正された際に分類ルールを自動登録する
  - 既存ルールがある場合は更新する
  - _Requirements: 4.3, 6.5_

- [ ] 7. AI費目分類機能
- [ ] 7.1 分類サービスの実装
  - ルールベース分類を優先実行する機能を実装する
  - Gemini APIを呼び出して費目を推論する機能を実装する
  - AIレスポンスの検証と有効な費目へのマッピングを行う
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 7.2 AIエラーハンドリングとフォールバック
  - API制限・ネットワークエラー時のフォールバック処理を実装する
  - エラー時は「使途不明金」として登録する
  - 分類ソース（RULE/AI/FALLBACK）を記録する
  - _Requirements: 6.4_

- [ ] 8. 非同期ジョブ管理機能
- [ ] 8.1 ジョブサービスの実装
  - ジョブの作成、状態更新、取得機能を実装する
  - pending状態のジョブを古い順に取得する
  - running状態のジョブ存在チェック（多重実行防止）を実装する
  - _Requirements: 2.1, 2.3, 2.4, 2.5, 2.6_

- [ ] 8.2 ジョブAPIエンドポイントの実装
  - POST /api/jobs でジョブを投入し、即座にレスポンスを返す
  - GET /api/jobs で最近のジョブ一覧を取得する
  - GET /api/jobs/:id でジョブ詳細を取得する
  - _Requirements: 2.1_

- [ ] 8.3 定期スケジューラーの実装
  - node-cronで設定時刻（深夜3時）にSCRAPE_ALLジョブを自動投入する
  - スケジュール設定を環境変数で制御可能にする
  - _Requirements: 2.2_

- [ ] 8.4 バックグラウンドワーカーの実装
  - ポーリングループでpendingジョブを監視する
  - ジョブを取得してrunning状態に更新後、スクレイピングを実行する
  - 完了時にcompleted、失敗時にfailedとエラーメッセージを記録する
  - 多重実行を防止する（running中は次のジョブに着手しない）
  - _Requirements: 2.3, 2.4, 2.5, 2.6_

- [ ] 9. スクレイピング機能
- [ ] 9.1 スクレイパー基盤の実装
  - Playwrightを使用したブラウザ自動操作の基盤を構築する
  - 金融機関共通のスクレイパーインターフェースを定義する
  - 認証情報の復号とログイン処理の共通ロジックを実装する
  - _Requirements: 1.1, 10.2_

- [ ] 9.2 (P) 楽天銀行スクレイパーの実装
  - 楽天銀行サイトへのログインと取引明細ページへのアクセスを実装する
  - 取引データ（日付、金額、摘要）のパースと正規化を行う
  - 現在残高の取得を実装する
  - _Requirements: 1.1, 1.6_

- [ ] 9.3 (P) 三井住友銀行スクレイパーの実装
  - SMBCサイトへのログインと取引明細取得を実装する
  - 取引データのパースと正規化を行う
  - _Requirements: 1.1, 1.6_

- [ ] 9.4 (P) 三菱UFJ銀行スクレイパーの実装
  - 三菱UFJサイトへのログインと取引明細取得を実装する
  - 取引データのパースと正規化を行う
  - _Requirements: 1.1, 1.6_

- [ ] 9.5 (P) SBI新生銀行スクレイパーの実装
  - SBI新生銀行サイトへのログインと取引明細取得を実装する
  - 取引データのパースと正規化を行う
  - _Requirements: 1.1, 1.6_

- [ ] 9.6 (P) 楽天証券スクレイパーの実装
  - 楽天証券サイトへのログインと取引明細取得を実装する
  - 取引データのパースと正規化を行う
  - _Requirements: 1.1, 1.6_

- [ ] 9.7 (P) ポケットカードスクレイパーの実装
  - ポケットカードサイトへのログインと取引明細取得を実装する
  - 取引データのパースと正規化を行う
  - _Requirements: 1.1, 1.6_

- [ ] 9.8 スクレイピング統合処理の実装
  - 全口座を順次スクレイピングする機能を実装する
  - 各取引に対して費目分類を実行する
  - 重複チェック後にDBへ登録し、残高を更新する
  - 部分的失敗時も他の金融機関処理を継続する
  - エラーをログに記録し、結果を集約する
  - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [ ] 10. 月次集計・分析機能
- [ ] 10.1 集計サービスの実装
  - 月別の総収入・総支出・純収支を計算する
  - 費目別の金額内訳と割合を算出する
  - 月別推移データ（過去N月分）を取得する
  - _Requirements: 7.1, 7.2_

- [ ] 10.2 集計APIエンドポイントの実装
  - GET /api/analytics/monthly で月次サマリーを取得する
  - GET /api/analytics/categories で費目別内訳を取得する
  - GET /api/analytics/trend で月別推移を取得する
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 11. フロントエンドUI実装
- [ ] 11.1 共通レイアウトとナビゲーション
  - アプリケーション共通のレイアウトコンポーネントを作成する
  - ヘッダー、ナビゲーションメニュー、フッターを実装する
  - レスポンシブデザインを適用する
  - _Requirements: 11.2_

- [ ] 11.2 (P) 口座管理画面の実装
  - 口座一覧と残高表示（種別ごとにグループ化）を実装する
  - 口座登録フォーム（認証情報入力含む）を実装する
  - 口座編集・削除機能を実装する
  - _Requirements: 8.1, 8.3, 9.1, 9.2, 9.3_

- [ ] 11.3 (P) 取引一覧・入力画面の実装
  - 月別の取引一覧表示を実装する
  - 手動取引入力フォームを実装する
  - 取引の編集・削除機能を実装する
  - 費目変更時の学習ルール自動登録を連携する
  - _Requirements: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [ ] 11.4 (P) 月次レポート画面の実装
  - 月次サマリー（収入・支出・純収支）を表示する
  - 費目別内訳を円グラフで表示する
  - 月別推移を棒グラフで表示する
  - 月選択ナビゲーションを実装する
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 11.5 ダッシュボード画面の実装
  - 「今すぐ更新」ボタンでジョブを投入する機能を実装する
  - ジョブステータスのポーリング表示を実装する
  - スクレイピングエラー時の警告表示を実装する
  - 最近の取引と残高サマリーを表示する
  - _Requirements: 1.4, 2.1_

- [ ] 11.6 (P) 費目管理画面の実装
  - 費目一覧表示を実装する
  - 費目の追加・編集・削除機能を実装する
  - 使用中費目の削除防止メッセージを表示する
  - _Requirements: 5.2, 5.3, 5.4, 5.5_

- [ ] 12. PWA対応とオフライン機能
- [ ] 12.1 PWA設定の最終調整
  - Web App Manifestにアイコン・テーマカラーを設定する
  - サービスワーカーによる静的アセットキャッシュを設定する
  - オフライン時のフォールバック表示を実装する
  - _Requirements: 11.1, 11.3_

- [ ] 13. 統合とテスト
- [ ] 13.1 バックエンドとフロントエンドの統合
  - CORS設定を適用する
  - APIエンドポイントとフロントエンドの接続を確認する
  - エラーハンドリングの一貫性を検証する
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 7.1, 8.1, 9.1_

- [ ] 13.2 単体テストの実装
  - EncryptionServiceの暗号化・復号テストを実装する
  - ClassifierServiceのルールベース分類テストを実装する
  - AnalyticsServiceの集計計算テストを実装する
  - TransactionServiceのCRUD操作テストを実装する
  - _Requirements: 5.1, 6.1, 7.1, 10.1_

- [ ] 13.3 統合テストの実装
  - ジョブ投入→ワーカー実行→完了のフローをテストする
  - APIエンドポイントのリクエスト/レスポンス検証を行う
  - _Requirements: 2.1, 2.3, 2.5_

## Requirements Coverage

| Requirement | Task(s) |
|-------------|---------|
| 1.1 | 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7 |
| 1.2 | 5.1, 9.8 |
| 1.3 | 5.1, 9.8 |
| 1.4 | 9.8, 11.5 |
| 1.5 | 9.8 |
| 1.6 | 9.2, 9.3, 9.4, 9.5, 9.6, 9.7 |
| 2.1 | 8.1, 8.2, 11.5, 13.1, 13.3 |
| 2.2 | 8.3 |
| 2.3 | 8.1, 8.4, 13.3 |
| 2.4 | 8.1, 8.4 |
| 2.5 | 8.1, 8.4, 13.3 |
| 2.6 | 8.1, 8.4 |
| 3.1 | 5.1, 5.2, 11.3, 13.1 |
| 3.2 | 5.1, 5.2, 11.3 |
| 3.3 | 1.3, 5.1, 5.2, 11.3 |
| 4.1 | 5.1, 5.2, 11.3, 13.1 |
| 4.2 | 5.1, 5.2, 11.3 |
| 4.3 | 6.1, 6.2, 11.3 |
| 5.1 | 1.3, 3.1, 13.1, 13.2 |
| 5.2 | 3.1, 3.2, 11.6 |
| 5.3 | 3.1, 3.2, 11.6 |
| 5.4 | 3.1, 3.2, 11.6 |
| 5.5 | 3.1, 3.2, 11.6 |
| 6.1 | 6.1, 7.1, 13.2 |
| 6.2 | 7.1 |
| 6.3 | 7.1 |
| 6.4 | 7.2 |
| 6.5 | 6.1, 6.2 |
| 7.1 | 10.1, 10.2, 11.4, 13.1, 13.2 |
| 7.2 | 10.1, 10.2, 11.4 |
| 7.3 | 10.2, 11.4 |
| 8.1 | 4.1, 4.2, 11.2, 13.1 |
| 8.2 | 4.1 |
| 8.3 | 4.2, 11.2 |
| 9.1 | 4.1, 4.2, 11.2, 13.1 |
| 9.2 | 4.1, 4.2, 11.2 |
| 9.3 | 4.1, 4.2, 11.2 |
| 9.4 | 2.1, 4.1 |
| 10.1 | 1.1, 2.1, 13.2 |
| 10.2 | 2.1, 9.1 |
| 10.3 | 2.1 |
| 11.1 | 1.2, 12.1 |
| 11.2 | 1.2, 11.1 |
| 11.3 | 12.1 |
