# Requirements Document

## Introduction

本ドキュメントは、個人向け家計簿Webアプリケーションの機能要件を定義する。本アプリケーションは、無料（低コスト）を最優先とし、Webスクレイピングによる金融機関自動連携とAIを活用した費目自動分類を特徴とする。ターゲットユーザーは開発者本人のみであり、PWA対応によるモバイルフレンドリーな設計を目指す。

## Requirements

### Requirement 1: 金融機関自動連携

**Objective:** ユーザーとして、登録した金融機関・カードの取引履歴を自動で取得したい。これにより、手動入力の手間を省き、正確な家計管理を実現する。

#### Acceptance Criteria

1. When スクレイピングジョブが実行される, the 自動取り込みサービス shall 認証情報を用いて金融機関Webサイトにログインし、取引明細を取得する
2. When 新規取引明細が取得される, the 自動取り込みサービス shall 取引データをDBに登録し、口座残高を更新する
3. When 取得した取引データ（日付、金額、摘要）がDBに既存の場合, the 自動取り込みサービス shall 重複データとして登録をスキップする
4. If スクレイピングがエラー（サイト仕様変更、二段階認証等）で失敗した場合, then the 自動取り込みサービス shall エラーをログに記録し、ダッシュボードに警告を表示する
5. While 特定の金融機関のスクレイピングが失敗中である, the 自動取り込みサービス shall 他の金融機関の取り込み処理を継続する
6. The 自動取り込みサービス shall 楽天銀行、三井住友銀行、三菱UFJ銀行、SBI新生銀行、楽天証券、ポケットカードに対応する

### Requirement 2: 非同期ジョブ管理

**Objective:** ユーザーとして、スクレイピング処理を非同期で実行したい。これにより、UI操作がブロックされず、快適に利用できる。

#### Acceptance Criteria

1. When ユーザーが「今すぐ更新」ボタンを押す, the ジョブ管理サービス shall jobsテーブルにpending状態でジョブを作成し、即座にレスポンスを返す
2. When 設定時刻（例：深夜3時）になる, the ジョブ管理サービス shall 全金融機関を対象としたSCRAPE_ALLジョブを自動投入する
3. When pending状態のジョブが存在する, the ワーカープロセス shall 最古のジョブをrunning状態に変更しスクレイピングを開始する
4. While running状態のジョブが存在する, the ワーカープロセス shall 次のジョブに着手しない（多重実行を防止する）
5. When ジョブが完了する, the ワーカープロセス shall ステータスをcompletedに更新する
6. If ジョブが失敗した場合, then the ワーカープロセス shall ステータスをfailedに更新し、エラーメッセージを記録する

### Requirement 3: 取引データ手動入力

**Objective:** ユーザーとして、現金取引など自動取り込み対象外の取引を手動で登録したい。これにより、完全な家計管理を実現する。

#### Acceptance Criteria

1. When ユーザーが手動入力フォームを送信する, the 取引管理サービス shall 日付、金額、費目、メモ、支払い元を含む取引データをDBに登録する
2. When 取引データが手動入力される, the 取引管理サービス shall is_manualフラグをtrueに設定する
3. The 取引管理サービス shall すべての取引について日付、金額、費目、メモ、支払い/入金元（口座・カード名）を保持する

### Requirement 4: 取引データ修正・削除

**Objective:** ユーザーとして、登録済みの取引データを修正・削除したい。これにより、誤入力の訂正や不要データの整理ができる。

#### Acceptance Criteria

1. When ユーザーが取引データの編集を保存する, the 取引管理サービス shall 金額、費目、メモなどの修正をDBに反映する
2. When ユーザーが取引データを削除する, the 取引管理サービス shall 該当データをDBから削除する
3. When 費目が手動で修正される, the 分類ルール管理サービス shall 該当摘要と費目の紐付けをauto_rulesテーブルに保存する

### Requirement 5: 費目（カテゴリ）管理

**Objective:** ユーザーとして、費目を自由に追加・編集・削除したい。これにより、自分の家計管理スタイルに合わせたカテゴリ分けができる。

#### Acceptance Criteria

1. The 費目管理サービス shall デフォルト費目リスト（給与、臨時収入、家賃/住宅ローン、水道光熱費、通信費、保険、サブスク、食費、日用品、交際費、交通費、美容・衣服、医療費、投資/貯金、使途不明金）を初期データとして提供する
2. When ユーザーが新しい費目を追加する, the 費目管理サービス shall 費目をDBに登録する
3. When ユーザーが費目名を編集する, the 費目管理サービス shall 費目名の変更をDBに反映する
4. When ユーザーが費目を削除する, the 費目管理サービス shall 該当費目をDBから削除する
5. If 削除対象の費目が取引データに紐付いている場合, then the 費目管理サービス shall 削除を防止するか、代替費目への振り替えを促す

### Requirement 6: AI費目自動分類

**Objective:** ユーザーとして、取引の費目を自動で分類してほしい。これにより、手動での費目設定の手間を省く。

#### Acceptance Criteria

1. When 新規取引が登録される and 摘要に一致するルールがauto_rulesテーブルに存在する, the 分類サービス shall ルールに基づき費目を自動設定する（完全一致ルール優先）
2. When 新規取引が登録される and 一致するルールが存在しない, the 分類サービス shall Gemini APIに摘要と費目リストを送信し、AIによる費目推論を実行する
3. When AIから費目推論結果を受信する, the 分類サービス shall 推論された費目を取引データに設定する
4. If AI推論がエラー（API制限、ネットワークエラー等）で失敗した場合, then the 分類サービス shall 費目を「使途不明金」として登録し、未分類フラグを設定する
5. When ユーザーがAI判定の費目を手動で修正する, the 分類ルール管理サービス shall 該当摘要と修正後の費目をauto_rulesテーブルに学習ルールとして保存する

### Requirement 7: 月次集計・分析

**Objective:** ユーザーとして、月ごとの収支を集計・分析したい。これにより、家計の状況を把握できる。

#### Acceptance Criteria

1. When ユーザーが月次レポート画面を表示する, the 集計サービス shall 指定月の総収入、総支出、純収支を計算して表示する
2. When ユーザーが月次レポート画面を表示する, the 集計サービス shall 指定月の費目別内訳を集計して表示する
3. The 集計サービス shall 月次集計結果を円グラフ（費目別支出割合）と棒グラフ（月別推移）で視覚化する

### Requirement 8: 残高確認

**Objective:** ユーザーとして、連携口座と現金の現在残高を一覧で確認したい。これにより、資産全体を把握できる。

#### Acceptance Criteria

1. When ユーザーが残高一覧画面を表示する, the 残高管理サービス shall 全口座（銀行、カード、証券、現金）の現在残高を一覧表示する
2. When スクレイピングにより残高が更新される, the 残高管理サービス shall 該当口座の残高をDBに反映する
3. The 残高管理サービス shall 口座種別（BANK、CARD、SECURITIES、CASH）ごとにグループ化して残高を表示する

### Requirement 9: 口座・カード管理

**Objective:** ユーザーとして、連携対象の口座・カードを管理したい。これにより、スクレイピング対象を制御できる。

#### Acceptance Criteria

1. When ユーザーが新しい口座を登録する, the 口座管理サービス shall 口座名、種別、認証情報をDBに保存する
2. When ユーザーが口座の認証情報を更新する, the 口座管理サービス shall 暗号化して認証情報を更新する
3. When ユーザーが口座を削除する, the 口座管理サービス shall 該当口座と関連する取引データの扱いを確認後、削除を実行する
4. The 口座管理サービス shall 認証情報を暗号化してDBに保存する

### Requirement 10: セキュリティ

**Objective:** ユーザーとして、金融機関の認証情報を安全に管理したい。これにより、セキュリティリスクを最小化する。

#### Acceptance Criteria

1. The セキュリティサービス shall 金融機関の認証情報を暗号化してDBに保存する
2. The セキュリティサービス shall 認証情報の復号はスクレイピング実行時のみに限定する
3. The セキュリティサービス shall 認証情報へのアクセスログを記録する

### Requirement 11: PWA対応

**Objective:** ユーザーとして、モバイル端末でも快適に利用したい。これにより、外出先でも家計管理ができる。

#### Acceptance Criteria

1. The Webアプリケーション shall PWA（Progressive Web App）としてインストール可能である
2. The Webアプリケーション shall レスポンシブデザインでモバイル端末に最適化された表示を提供する
3. Where オフライン状態である, the Webアプリケーション shall キャッシュされたデータを表示する

## Project Description (Input)

📝 家計簿アプリ要件定義書
1. プロジェクト概要と基本方針（変更なし）
   項目	内容
   開発動機	市販アプリの機能制限を解消し、自分の利用に最適化された低コストな家計簿を実現する。
   基本方針	無料（低コスト）を最優先とし、すべての金融機関の連携をスクレイピングで実装する。
   ターゲットユーザー	開発者本人のみ。
2. 機能要件 (Functional Requirements)
   No.	機能カテゴリ	機能名	仕様/実装アプローチ
   F-01	データ連携	自動取り込み機能（核）	登録された金融機関・カードの取引履歴を自動で取得し、入出金データとして登録する。実行頻度は1日1回を目標とする。
   F-01a	実装詳細	実装統一	全ての連携対象機関（楽天銀行、三井住友銀行、三菱UFJ銀行、SBI新生銀行、楽天証券、ポケットカード）について、サーバー側での認証情報保持とヘッドレスブラウザによるWebスクレイピングでデータを取得する。
   F-02	記録	手動入力	現金取引など、自動取り込み対象外の取引を手動で登録する。
   F-03	記録	データ修正・削除	登録された入出金データ（金額、費目、メモなど）の修正および削除を可能とする。
   F-04	管理項目	一般的な項目	すべての取引について**日付、金額、費目（カテゴリ）、メモ、支払い/入金元（口座・カード名）**を保持する。
   F-05	集計・分析	月次集計	月ごとの総収入、総支出、純収支、および費目別の内訳を集計する。
   F-06	集計・分析	簡易グラフ表示	月次集計結果を円グラフや棒グラフなどの簡易な形式で表示する。
   F-07	データ管理	残高確認	連携口座と手入力現金の現在の残高を一覧で確認できる。
3. 非機能要件 (Non-Functional Requirements)
   項目	内容
   動作環境	Webアプリケーションとして実装し、**PWA（Progressive Web App）**対応を検討することでモバイルフレンドリーとする。
   セキュリティ	サーバーに保持する金融機関の認証情報は安全に暗号化し、最高レベルで保護する。
   メンテナンス	【重要】 すべての連携がスクレイピングとなるため、金融機関のWebサイト仕様変更に伴うメンテナンスコストが非常に高く、データの継続的な取得が保証されないリスクを許容する。
   コスト	運用コストは無料または極めて低コストを目指す。
